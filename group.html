<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat - BondBase Gaming</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons (Modern Line Icons) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Howler.js for advanced audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    
    <style>
        /* ==========================================================================
           GAMING FEATURES STYLES
           ========================================================================== */
        
        /* Gaming Controls Bar */
        .gaming-controls-bar {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 100%;
            width: 100%;
        }
        
        .gaming-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .gaming-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .gaming-btn:active {
            transform: translateY(0);
        }
        
        .gaming-btn.voice-snippet {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }
        
        .gaming-btn.voice-snippet:hover {
            background: linear-gradient(135deg, #43A047 0%, #1B5E20 100%);
        }
        
        .gaming-btn.start-game {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        .gaming-btn.start-game:hover {
            background: linear-gradient(135deg, #F57C00 0%, #E65100 100%);
        }
        
        .gaming-btn.suggest-mode {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }
        
        .gaming-btn.suggest-mode:hover {
            background: linear-gradient(135deg, #8E24AA 0%, #6A1B9A 100%);
        }
        
        .gaming-btn .feather {
            width: 16px;
            height: 16px;
            stroke: white;
            stroke-width: 2.5;
            flex-shrink: 0;
        }
        
        /* Voice Recording Overlay */
        .recording-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
        }
        
        .recording-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #4CAF50;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            max-width: 300px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: pulse 2s infinite;
        }
        
        .recording-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .recording-dot {
            width: 20px;
            height: 20px;
            background: #ff4757;
            border-radius: 50%;
            animation: recordingPulse 1.5s infinite;
        }
        
        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        .recording-timer {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .stop-recording-btn {
            background: linear-gradient(135deg, #ff4757 0%, #ff2e43 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
        }
        
        .stop-recording-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }
        
        /* Game Selector Modal */
        .game-selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            padding: 20px;
        }
        
        .game-selector-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            color: white;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
        }
        
        .game-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .game-selector-header h3 {
            margin: 0;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .close-game-selector {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.3s;
        }
        
        .close-game-selector:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .game-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .game-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .game-option:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            transform: translateY(-5px);
        }
        
        .game-option.selected {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }
        
        .game-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
        }
        
        .game-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .game-description {
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .start-game-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .start-game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        /* Mode Selector */
        .mode-selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10003;
            padding: 20px;
        }
        
        .mode-selector-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            color: white;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
        }
        
        .mode-options {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .mode-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .mode-option:hover {
            background: rgba(156, 39, 176, 0.2);
            border-color: #9C27B0;
            transform: translateX(5px);
        }
        
        .mode-option.selected {
            background: rgba(156, 39, 176, 0.3);
            border-color: #9C27B0;
            box-shadow: 0 0 20px rgba(156, 39, 176, 0.3);
        }
        
        .mode-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .mode-info {
            flex: 1;
            min-width: 0; /* Prevent flex item from overflowing */
        }
        
        .mode-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .mode-description {
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        /* Active Mode Indicator */
        .active-mode-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 9998;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(156, 39, 176, 0.4);
            animation: slideInRight 0.5s ease;
            max-width: 300px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .mode-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            flex-shrink: 0;
        }
        
        /* Voice Snippet Player */
        .voice-snippet-player {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            margin: 5px 0;
            max-width: 300px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .voice-snippet-player:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .play-pause-btn {
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4CAF50;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .voice-waveform {
            flex: 1;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            min-width: 0;
        }
        
        .voice-progress {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 0%;
            background: rgba(255, 255, 255, 0.3);
            transition: width 0.1s linear;
        }
        
        .voice-duration {
            font-size: 12px;
            opacity: 0.9;
            flex-shrink: 0;
        }
        
        /* User Identity Badges */
        .identity-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 5px;
            vertical-align: middle;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .user-glow {
            text-shadow: 0 0 10px rgba(255, 221, 89, 0.5);
        }
        
        /* Session Timer */
        .session-timer-display {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            color: white;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 9997;
            animation: fadeIn 0.5s ease;
        }
        
        .session-timer-display .feather {
            width: 14px;
            height: 14px;
            stroke: #667eea;
        }
        
        /* Achievement Notification */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 300px;
            display: none;
            z-index: 10004;
            animation: slideInRight 0.5s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .achievement-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .achievement-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .achievement-details {
            flex: 1;
            min-width: 0;
        }
        
        .achievement-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .achievement-description {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .achievement-unlocked {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Game Results Display */
        .game-results {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            color: white;
            animation: fadeIn 0.5s ease;
            overflow: hidden;
        }
        
        .game-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .game-results-title {
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .winner-badge {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }
        
        .leaderboard {
            margin-bottom: 15px;
        }
        
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .leaderboard-entry.winner {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            flex: 1;
        }
        
        .player-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .player-score {
            font-weight: bold;
            color: #4CAF50;
            flex-shrink: 0;
        }
        
        .game-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        /* Voice Channels Section */
        .voice-channels-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            margin: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .voice-channels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
            position: relative;
            z-index: 2;
        }
        
        .voice-channels-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
            overflow: hidden;
        }
        
        .voice-channels-header h3 .feather {
            width: 22px;
            height: 22px;
            stroke: #ffdd59;
            stroke-width: 2.5;
            flex-shrink: 0;
        }
        
        /* Gaming Activity Strip */
        .gaming-activity-strip {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            display: flex;
            gap: 20px;
            overflow-x: auto;
            scrollbar-width: none;
            position: sticky;
            top: 0;
            z-index: 100;
            border-top: 2px solid var(--primary);
            max-width: 100%;
        }
        
        .gaming-activity-strip::-webkit-scrollbar {
            display: none;
        }
        
        .activity-sections {
            display: flex;
            gap: 20px;
            flex: 1;
            min-width: 0;
        }
        
        .activity-section {
            min-width: 150px;
            max-width: 200px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 11px;
            color: var(--text-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .section-header svg {
            color: var(--primary-light);
        }
        
        .section-items {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .activity-user {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            max-width: 100%;
        }
        
        .activity-user:hover {
            background: rgba(var(--primary-rgb, 179, 0, 75), 0.2);
            transform: translateY(-1px);
        }
        
        .activity-avatar {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .activity-name {
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }
        
        .typing-dots {
            display: flex;
            gap: 1px;
        }
        
        .typing-dots span {
            animation: typingDot 1.4s infinite;
            animation-delay: calc(var(--dot-index) * 0.2s);
            color: var(--primary-light);
        }
        
        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        
        /* Game Containers */
        .game-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
            position: relative;
            overflow: hidden;
            animation: slideInUp 0.3s ease;
            max-width: 100%;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(var(--primary-rgb, 179, 0, 75), 0.1) 50%, transparent 70%);
            animation: gameShimmer 3s infinite;
        }
        
        @keyframes gameShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .game-header h3 {
            margin: 0;
            color: white;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
        }
        
        .game-timer {
            background: rgba(255, 255, 255, 0.1);
            color: #ffdd59;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
            animation: pulse 1s infinite;
            flex-shrink: 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .game-content {
            color: white;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .game-players {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .game-player {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: #aaa;
            max-width: 100%;
        }
        
        .game-player img {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        /* Mode-specific animations */
        .slow-message {
            animation: slowAppear 3s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes slowAppear {
            0% { opacity: 0; transform: translateY(20px) scale(0.9); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .chaos-message {
            animation: floatAround 20s infinite linear;
            position: relative;
            z-index: 100;
            max-width: 100%;
            overflow: hidden;
        }
        
        @keyframes floatAround {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(50px, 30px) rotate(90deg); }
            50% { transform: translate(30px, 50px) rotate(180deg); }
            75% { transform: translate(-30px, 30px) rotate(270deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        
        /* Fade animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Game-specific styles */
        .trivia-game {
            color: white;
            overflow: hidden;
        }
        
        .trivia-question {
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 500;
            text-align: center;
            overflow-wrap: break-word;
        }
        
        .trivia-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .trivia-option {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .trivia-option:hover {
            background: rgba(var(--primary-rgb, 179, 0, 75), 0.5);
            transform: translateY(-2px);
        }
        
        .reaction-game {
            text-align: center;
            color: white;
            overflow: hidden;
        }
        
        .reaction-instruction {
            font-size: 14px;
            margin-bottom: 15px;
            font-weight: 500;
            overflow-wrap: break-word;
        }
        
        .reaction-box {
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            flex-shrink: 0;
        }
        
        .reaction-box:hover {
            border-color: var(--primary-light);
        }
        
        .reaction-box.ready {
            background: #4CAF50;
            animation: pulseReady 0.5s infinite alternate;
        }
        
        @keyframes pulseReady {
            from { box-shadow: 0 0 10px rgba(76, 175, 80, 0.5); }
            to { box-shadow: 0 0 20px rgba(76, 175, 80, 0.8); }
        }
        
        .reaction-time {
            font-size: 14px;
            font-weight: bold;
            color: #ffdd59;
        }
        
        /* Existing styles from original group.html */
        :root {
            --primary: #b3004b;
            --primary-dark: #7a0034;
            --primary-light: #e63986;
            --primary-rgb: 179, 0, 75;
            --secondary: #8b0000;
            --accent: #444;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-light: #9ca3af;
            --bg-primary: #0b0b0b;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --border: #2e2e2e;
            --accent-color: #b3004b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.8);
            --radius: 12px;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .chat-container {
            display: flex;
            height: 100vh;
            max-width: 100vw;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            min-width: 0;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .back-btn:hover {
            color: var(--primary-light);
        }

        .back-btn .feather {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            flex-shrink: 0;
        }

        .group-header-info {
            text-align: center;
            padding: 0 10px;
            max-width: 100%;
            overflow: hidden;
        }

        .group-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 10px;
            border: 2px solid var(--primary);
            flex-shrink: 0;
        }

        .group-name-sidebar {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .group-members-count {
            font-size: 0.85rem;
            color: var(--text-light);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        /* CALL BUTTONS STYLES */
        .call-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 100%;
        }

        .call-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .call-btn:active {
            transform: translateY(0);
        }

        .call-btn.voice-call {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
        }

        .call-btn.voice-call:hover {
            background: linear-gradient(135deg, #43A047 0%, #1B5E20 100%);
        }

        .call-btn.group-call {
            background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%);
            color: white;
        }

        .call-btn.group-call:hover {
            background: linear-gradient(135deg, #1E88E5 0%, #0A3A7A 100%);
        }

        .call-btn .feather {
            width: 18px;
            height: 18px;
            stroke: white;
            stroke-width: 2.5;
            flex-shrink: 0;
        }

        /* Sidebar content */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-width: 0;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .members-list {
            margin-bottom: 30px;
            overflow: hidden;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            min-width: 0;
        }

        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .member-info {
            flex: 1;
            min-width: 0;
        }

        .member-name {
            font-size: 0.9rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .member-bio {
            font-size: 0.8rem;
            color: var(--text-light);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .member-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9E9E9E;
            flex-shrink: 0;
        }

        .member-status.online {
            background: #00FF00;
        }

        .rules-list {
            list-style: none;
            overflow: hidden;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-width: 0;
        }

        .rule-item .feather {
            width: 16px;
            height: 16px;
            stroke: var(--primary-light);
            stroke-width: 2.5;
            margin-top: 2px;
            flex-shrink: 0;
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            max-width: calc(100vw - var(--sidebar-width));
        }

        @media (max-width: 768px) {
            .chat-main {
                max-width: 100vw;
            }
        }

        .chat-header {
            background: var(--bg-card);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            min-width: 0;
        }

        .chat-title {
            font-size: 1.3rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .chat-subtitle {
            font-size: 0.9rem;
            color: var(--text-light);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        /* CHAT HEADER ACTIONS WITH CALL BUTTON */
        .chat-header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .header-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-light);
        }

        .header-btn .feather {
            width: 20px;
            height: 20px;
            stroke: currentColor;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-primary);
            position: relative;
            min-width: 0;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .no-messages {
            text-align: center;
            color: var(--text-light);
            padding: 40px 20px;
            display: none;
        }

        /* Skeleton Loading Styles */
        .messages-loading {
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .messages-loading.active {
            display: block;
        }

        .message-group.loading {
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
            overflow: hidden;
        }

        .loading-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            float: left;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .loading-content {
            margin-left: 52px;
            overflow: hidden;
        }

        .loading-line {
            height: 12px;
            background: var(--bg-card);
            border-radius: 4px;
            margin-bottom: 8px;
            animation: pulse 1.5s infinite;
        }

        .loading-line.short {
            width: 40%;
        }

        .loading-line.medium {
            width: 60%;
        }

        .loading-line.long {
            width: 80%;
        }

        /* Message Styles (Discord-like) */
        .message-group {
            margin-bottom: 20px;
            position: relative;
            animation: fadeInUp 0.3s ease;
            overflow: hidden;
            max-width: 100%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .message-sender {
            font-weight: 600;
            font-size: 1rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-left: 8px;
            font-weight: normal;
            flex-shrink: 0;
        }

        .message-content {
            margin-left: 52px;
            font-size: 0.95rem;
            line-height: 1.4;
            overflow: hidden;
        }

        .message-text {
            margin-bottom: 5px;
            word-wrap: break-word;
            padding: 8px 12px;
            border-radius: 6px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .message-text:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* System message styling */
        .system-message {
            background: rgba(0,0,0,0.02);
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            border-radius: 4px;
            padding: 4px 8px;
            margin: 4px 0;
            font-size: 12px;
            overflow: hidden;
        }

        /* Reply preview in messages */
        .replying-to {
            background: rgba(114, 137, 218, 0.08);
            border-left: 3px solid #7289da;
            padding: 6px 10px;
            margin-bottom: 6px;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            overflow: hidden;
            max-height: 32px;
            max-width: 100%;
        }

        .replying-to .reply-sender {
            font-weight: 600;
            color: #7289da;
            font-size: 12px;
            margin: 0 3px;
            flex-shrink: 0;
        }

        /* Reply Indicator (shown when replying to a message) */
        .reply-indicator {
            background: rgba(114, 137, 218, 0.1);
            border-left: 3px solid #7289da;
            padding: 10px 12px;
            margin: 0;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
            animation: slideDown 0.2s ease;
            max-height: 44px;
            overflow: hidden;
            max-width: 100%;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reply-indicator-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 8px;
            max-width: calc(100% - 40px);
            min-width: 0;
        }

        .reply-sender {
            font-weight: 600;
            color: #7289da;
            margin: 0 3px;
            white-space: nowrap;
        }

        .cancel-reply {
            background: none;
            border: none;
            color: #7289da;
            cursor: pointer;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            min-height: 32px;
            flex-shrink: 0;
        }

        .cancel-reply:hover {
            background: rgba(114, 137, 218, 0.1);
        }

        .cancel-reply .feather {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }

        /* Image messages */
        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 5px;
        }

        /* Input Area */
        .input-container {
            background: var(--bg-card);
            padding: 20px;
            border-top: 1px solid var(--border);
            position: relative;
            min-width: 0;
        }

        .message-input-container {
            display: flex;
            align-items: center;
            gap: 2px;
            max-width: 100%;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 18px;
            color: var(--text-primary);
            font-size: 0.7rem;
            font-family: 'Inter', sans-serif;
            resize: none;
            max-height: 120px;
            min-height: 44px;
            min-width: 0;
            max-width: 100%;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-light);
        }

        .input-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-light);
        }

        .action-btn .feather {
            width: 22px;
            height: 22px;
            stroke: currentColor;
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: var(--primary-light);
        }

        .send-btn:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .send-btn .feather {
            width: 20px;
            height: 20px;
            stroke: white;
            stroke-width: 2.5;
        }

        /* File Input Button */
        .file-input-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-input-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-light);
        }

        .file-input-btn .feather {
            width: 22px;
            height: 22px;
            stroke: currentColor;
        }

        /* Lazy Loading More Indicator */
        .load-more-container {
            text-align: center;
            padding: 20px;
            margin: 10px 0;
            display: none;
            max-width: 100%;
        }

        .load-more-container.visible {
            display: block;
        }

        .load-more-btn {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            max-width: 100%;
            overflow: hidden;
        }

        .load-more-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .load-more-btn .feather {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            flex-shrink: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
                width: 100%;
                max-width: 300px;
            }

            .sidebar.active {
                display: flex;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1000;
                width: 100%;
                max-width: 300px;
            }

            .mobile-menu-btn {
                display: block;
            }

            .reply-indicator {
                padding: 8px 10px;
                font-size: 12px;
                max-height: 40px;
            }
            
            .reply-indicator-content {
                max-width: calc(100% - 35px);
            }
            
            .replying-to {
                padding: 5px 8px;
                font-size: 11px;
                max-height: 28px;
            }
            
            .cancel-reply {
                min-width: 28px;
                min-height: 28px;
                padding: 3px 6px;
            }
            
            .cancel-reply .feather {
                width: 12px;
                height: 12px;
            }

            /* Mobile call buttons adjustments */
            .call-buttons {
                gap: 8px;
            }

            .call-btn {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
            
            /* Gaming controls responsive */
            .gaming-controls-bar {
                gap: 8px;
            }
            
            .gaming-btn {
                padding: 8px 14px;
                font-size: 0.8rem;
            }
            
            .activity-section {
                min-width: 130px;
            }
        }

        @media (max-width: 480px) {
            .chat-header {
                padding: 12px 15px;
            }

            .messages-container {
                padding: 15px;
            }

            .input-container {
                padding: 15px;
            }

            .message-input {
                padding: 10px 12px;
            }

            .reply-indicator {
                padding: 6px 8px;
                font-size: 11px;
                max-height: 36px;
            }
            
            .reply-indicator-content {
                max-width: calc(100% - 30px);
            }

            /* Small screen call buttons */
            .call-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .call-btn {
                width: 100%;
                justify-content: center;
                padding: 10px;
            }
            
            /* Gaming controls small screens */
            .gaming-controls-bar {
                flex-direction: column;
            }
            
            .gaming-btn {
                width: 100%;
                justify-content: center;
            }
            
            .activity-sections {
                gap: 10px;
            }
            
            .activity-section {
                min-width: 110px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button onclick="location.href='group.html'" class="back-btn" id="backBtn">
                    <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back to Groups
                </button>
                <div class="group-header-info">
                    <img src="" alt="Group Avatar" class="group-avatar" id="groupAvatar">
                    <h3 class="group-name-sidebar" id="groupNameSidebar"></h3>
                    <p class="group-members-count" id="groupMembersCount"></p>
                    
                    <!-- Gaming Controls in Sidebar -->
                    <div class="gaming-controls-bar">
                        <button id="voiceSnippetBtn" class="gaming-btn voice-snippet">
                            <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                            Voice Snippet
                        </button>
                        
                        <button id="startGameBtn" class="gaming-btn start-game">
                            <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <line x1="6" y1="12" x2="10" y2="12"></line>
                                <line x1="8" y1="10" x2="8" y2="14"></line>
                                <line x1="15" y1="13" x2="15.01" y2="13"></line>
                                <line x1="18" y1="11" x2="18.01" y2="11"></line>
                                <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                            </svg>
                            Start Game
                        </button>
                    </div>
                    
                    <!-- CALL BUTTONS IN SIDEBAR -->
                    <div class="call-buttons">
                        <button id="groupVoiceCallBtn" class="call-btn group-call">
                            <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            Start Group Call
                        </button>
                    </div>
                </div>
            </div>
            <div class="sidebar-content">
                <div class="members-list">
                    <h4 class="section-title">Members</h4>
                    <div id="membersList">
                        <!-- Members will be loaded here -->
                    </div>
                </div>
                <div class="group-rules">
                    <h4 class="section-title">Group Rules</h4>
                    <ul class="rules-list" id="rulesList">
                        <!-- Rules will be loaded here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <div>
                    <h2 class="chat-title" id="chatTitle">Loading..</h2>
                    <p class="chat-subtitle" id="chatSubtitle">..</p>
                </div>
                <div class="chat-header-actions">
                    <!-- Suggest Mode Button -->
                    <button id="suggestModeBtn" class="gaming-btn suggest-mode" style="padding: 8px 15px; font-size: 0.9rem;">
                        <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                        </svg>
                        Suggest Mode
                    </button>
                    
                    <!-- CALL BUTTON IN HEADER -->
                    <button id="groupVoiceCallBtnMobile" class="call-btn group-call" style="padding: 8px 15px; font-size: 0.9rem;">
                        <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        Group Call
                    </button>
                    
                    <button class="header-btn" id="sidebarToggle">
                        <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <button class="header-btn" id="infoBtn">
                        <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <!-- Initial skeleton loading -->
                <div id="initialLoading">
                    <div class="message-group loading">
                        <div class="loading-avatar"></div>
                        <div class="loading-content">
                            <div class="loading-line long"></div>
                            <div class="loading-line medium"></div>
                            <div class="loading-line short"></div>
                        </div>
                    </div>
                    <div class="message-group loading">
                        <div class="loading-avatar"></div>
                        <div class="loading-content">
                            <div class="loading-line long"></div>
                            <div class="loading-line medium"></div>
                            <div class="loading-line short"></div>
                        </div>
                    </div>
                    <div class="message-group loading">
                        <div class="loading-avatar"></div>
                        <div class="loading-content">
                            <div class="loading-line long"></div>
                            <div class="loading-line medium"></div>
                            <div class="loading-line short"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Load more button -->
                <div class="load-more-container" id="loadMoreContainer">
                    <button class="load-more-btn" id="loadMoreBtn">
                        <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                        Load Older Messages
                    </button>
                </div>
                
                <!-- Messages will be loaded here by your JavaScript -->
            </div>

            <!-- No messages -->
            <div class="no-messages" id="noMessages">
                <p>No messages yet. Start the conversation!</p>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="message-input-container">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Type your message here..."
                        rows="1"></textarea>
                    <div class="input-actions">
                        <!-- Image/File attachment button -->
                        <button class="file-input-btn" id="attachmentBtn">
                            <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                            </svg>
                        </button>
                        <!-- Emoji button -->
                        <button class="action-btn" id="emojiBtn">
                            <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                        </button>
                    </div>
                    <button class="send-btn" id="sendBtn" disabled>
                        <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS AND OVERLAYS FOR GAMING FEATURES -->
    
    <!-- Voice Recording Overlay -->
    <div id="recordingOverlay" class="recording-overlay" style="display: none;">
        <div class="recording-content">
            <div class="recording-indicator">
                <div class="recording-dot"></div>
                <span>Recording...</span>
            </div>
            <div class="recording-timer" id="recordingTimer">00:30</div>
            <button class="stop-recording-btn" id="stopRecordingBtn">
                <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
                Stop Recording
            </button>
        </div>
    </div>
    
    <!-- Game Selector Modal -->
    <div id="gameSelectorModal" class="game-selector-modal">
        <div class="game-selector-content">
            <div class="game-selector-header">
                <h3> Select a Mini-Game</h3>
                <button class="close-game-selector" id="closeGameSelector">&times;</button>
            </div>
            <div class="game-options">
                <div class="game-option" data-game="trivia">
                    <div class="game-icon">?</div>
                    <div class="game-name">Quick Trivia</div>
                    <div class="game-description">Answer simple questions</div>
                </div>
                <div class="game-option" data-game="reaction">
                    <div class="game-icon"></div>
                    <div class="game-name">Reaction Speed</div>
                    <div class="game-description">Tap when color changes</div>
                </div>
                <div class="game-option" data-game="scramble">
                    <div class="game-icon"></div>
                    <div class="game-name">Word Scramble</div>
                    <div class="game-description">Unscramble the word</div>
                </div>
                <div class="game-option" data-game="emojiRace">
                    <div class="game-icon"></div>
                    <div class="game-name">Emoji Race</div>
                    <div class="game-description">Click the right sequence</div>
                </div>
                <div class="game-option" data-game="aimTrainer">
                    <div class="game-icon"></div>
                    <div class="game-name">Aim Trainer</div>
                    <div class="game-description">Click moving targets</div>
                </div>
            </div>
            <button class="start-game-btn" id="confirmStartGame">
                <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Start Game
            </button>
        </div>
    </div>
    
    <!-- Mode Selector Modal -->
    <div id="modeSelectorModal" class="mode-selector-modal">
        <div class="mode-selector-content">
            <div class="game-selector-header">
                <h3> Suggest a Mode</h3>
                <button class="close-game-selector" id="closeModeSelector">&times;</button>
            </div>
            <div class="mode-options">
                <div class="mode-option" data-mode="slow">
                    <div class="mode-icon"></div>
                    <div class="mode-info">
                        <div class="mode-name">Cinematic Slow Mode</div>
                        <div class="mode-description">Messages appear slowly with animations</div>
                    </div>
                </div>
                <div class="mode-option" data-mode="chaos">
                    <div class="mode-icon"></div>
                    <div class="mode-info">
                        <div class="mode-name">Floating Chaos Mode</div>
                        <div class="mode-description">Messages float and collide for 5 minutes</div>
                    </div>
                </div>
                <div class="mode-option" data-mode="stealth">
                    <div class="mode-icon"></div>
                    <div class="mode-info">
                        <div class="mode-name">Blurred Stealth Mode</div>
                        <div class="mode-description">Usernames blur, only avatars speak</div>
                    </div>
                </div>
                <div class="mode-option" data-mode="night_raid">
                    <div class="mode-icon"></div>
                    <div class="mode-info">
                        <div class="mode-name">Night Raid Mode</div>
                        <div class="mode-description">Dark visuals with ambient sounds</div>
                    </div>
                </div>
            </div>
            <button class="start-game-btn" id="confirmSuggestMode">
                <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Suggest Mode to Group
            </button>
        </div>
    </div>
    
    <!-- Active Mode Indicator -->
    <div id="activeModeIndicator" class="active-mode-indicator" style="display: none;">
        <span id="activeModeName">Mode Active</span>
        <span class="mode-timer" id="modeTimer">05:00</span>
    </div>
    
    <!-- Session Timer -->
    <div id="sessionTimerDisplay" class="session-timer-display" style="display: none;">
        <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span id="sessionTime">0m</span>
    </div>
    
    <!-- Achievement Notification -->
    <div id="achievementNotification" class="achievement-notification" style="display: none;">
        <div class="achievement-content">
            <div class="achievement-icon" id="achievementIcon">
                <svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
            </div>
            <div class="achievement-details">
                <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
                <div class="achievement-description" id="achievementDescription">You earned an achievement!</div>
                <div class="achievement-unlocked">Achievement Unlocked!</div>
            </div>
        </div>
    </div>
    <!-- Import the calls module for voice calls -->
    <script type="module" src="calls.js"></script>
    <script type="module" src="group.js"></script>
        <!-- Import the gaming module -->
    <script type="module" src="gaming.js"></script>
    <script>
        // Lazy loading skeleton setup - just the skeleton showing functionality
        document.addEventListener('DOMContentLoaded', function() {
            const messagesContainer = document.getElementById('messagesContainer');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            const initialLoading = document.getElementById('initialLoading');
            const noMessages = document.getElementById('noMessages');
            
            // Your group.js will control these variables
            window.lazyLoadingState = {
                currentPage: 0,
                isLoading: false,
                hasMoreMessages: true
            };
            
            // Function to create skeleton loaders
            window.createSkeletonLoader = function(count = 3) {
                let skeletons = '';
                for (let i = 0; i < count; i++) {
                    skeletons += `
                        <div class="message-group loading">
                            <div class="loading-avatar"></div>
                            <div class="loading-content">
                                <div class="loading-line long"></div>
                                <div class="loading-line medium"></div>
                                <div class="loading-line short"></div>
                            </div>
                        </div>
                    `;
                }
                return skeletons;
            };
            
            // Function to show skeleton loading
            window.showSkeletonLoading = function() {
                const skeletonHTML = window.createSkeletonLoader();
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'messages-loading active';
                loadingDiv.innerHTML = skeletonHTML;
                
                // Insert at the top of messages
                const firstMessage = messagesContainer.querySelector('.message-group:not(.loading)');
                if (firstMessage) {
                    messagesContainer.insertBefore(loadingDiv, firstMessage);
                } else {
                    messagesContainer.appendChild(loadingDiv);
                }
                
                return loadingDiv;
            };
            
            // Function to remove skeleton loading
            window.removeSkeletonLoading = function(loadingElement) {
                if (loadingElement && loadingElement.parentNode) {
                    loadingElement.remove();
                }
            };
            
            // Function to clear initial loading
            window.clearInitialLoading = function() {
                if (initialLoading) {
                    initialLoading.style.display = 'none';
                }
            };
            
            // Function to show/hide load more button
            window.toggleLoadMoreButton = function(show) {
                if (loadMoreContainer) {
                    if (show) {
                        loadMoreContainer.classList.add('visible');
                    } else {
                        loadMoreContainer.classList.remove('visible');
                    }
                }
            };
            
            // Function to show/hide no messages
            window.toggleNoMessages = function(show) {
                if (noMessages) {
                    if (show) {
                        noMessages.style.display = 'block';
                    } else {
                        noMessages.style.display = 'none';
                    }
                }
            };
            
            // Load more button click handler
            loadMoreBtn.addEventListener('click', function() {
                // Your group.js should handle this
                if (typeof window.loadMoreMessages === 'function') {
                    window.loadMoreMessages();
                }
            });
            
            // Auto-load when scrolling near top (infinite scroll)
            messagesContainer.addEventListener('scroll', function() {
                if (messagesContainer.scrollTop < 100 && 
                    !window.lazyLoadingState.isLoading && 
                    window.lazyLoadingState.hasMoreMessages) {
                    
                    if (typeof window.loadMoreMessages === 'function') {
                        window.loadMoreMessages();
                    }
                }
            });
            
            // Your existing clearLoadingStates function
            window.clearLoadingStates = function() {
                window.clearInitialLoading();
                
                // Remove any skeleton loaders
                const skeletonLoaders = document.querySelectorAll('.messages-loading.active');
                skeletonLoaders.forEach(loader => loader.remove());
                
                // Remove loading class from any message groups
                const loadingGroups = document.querySelectorAll('.message-group.loading');
                loadingGroups.forEach(group => group.remove());
            };
            
            // ========================================
            // GAMING FEATURES FUNCTIONALITY
            // ========================================
            
            // Voice Snippet Recording
            const voiceSnippetBtn = document.getElementById('voiceSnippetBtn');
            const recordingOverlay = document.getElementById('recordingOverlay');
            const recordingTimer = document.getElementById('recordingTimer');
            const stopRecordingBtn = document.getElementById('stopRecordingBtn');
            
            let recordingTimeLeft = 30;
            let recordingInterval = null;
            
            if (voiceSnippetBtn) {
                voiceSnippetBtn.addEventListener('click', function() {
                    if (window.gamingChat) {
                        window.gamingChat.startVoiceRecording();
                    } else {
                        alert('Gaming system not initialized yet. Please wait...');
                    }
                });
            }
            
            if (stopRecordingBtn) {
                stopRecordingBtn.addEventListener('click', function() {
                    if (window.gamingChat) {
                        window.gamingChat.stopVoiceRecording();
                    }
                    hideRecordingOverlay();
                });
            }
            
            // Show recording overlay
            window.showRecordingOverlay = function() {
                recordingOverlay.style.display = 'flex';
                recordingTimeLeft = 30;
                recordingTimer.textContent = '00:30';
                
                // Start countdown
                recordingInterval = setInterval(() => {
                    recordingTimeLeft--;
                    const seconds = recordingTimeLeft % 60;
                    recordingTimer.textContent = `00:${seconds.toString().padStart(2, '0')}`;
                    
                    if (recordingTimeLeft <= 0) {
                        clearInterval(recordingInterval);
                        if (window.gamingChat) {
                            window.gamingChat.stopVoiceRecording();
                        }
                        hideRecordingOverlay();
                    }
                }, 1000);
            };
            
            // Hide recording overlay
            window.hideRecordingOverlay = function() {
                if (recordingInterval) {
                    clearInterval(recordingInterval);
                    recordingInterval = null;
                }
                recordingOverlay.style.display = 'none';
            };
            
            // Game Selector
            const startGameBtn = document.getElementById('startGameBtn');
            const gameSelectorModal = document.getElementById('gameSelectorModal');
            const closeGameSelector = document.getElementById('closeGameSelector');
            const confirmStartGame = document.getElementById('confirmStartGame');
            const gameOptions = document.querySelectorAll('.game-option');
            
            let selectedGame = null;
            
            if (startGameBtn) {
                startGameBtn.addEventListener('click', function() {
                    gameSelectorModal.style.display = 'flex';
                });
            }
            
            if (closeGameSelector) {
                closeGameSelector.addEventListener('click', function() {
                    gameSelectorModal.style.display = 'none';
                });
            }
            
            gameOptions.forEach(option => {
                option.addEventListener('click', function() {
                    gameOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedGame = this.dataset.game;
                });
            });
            
            if (confirmStartGame) {
                confirmStartGame.addEventListener('click', function() {
                    if (!selectedGame) {
                        alert('Please select a game first!');
                        return;
                    }
                    
                    gameSelectorModal.style.display = 'none';
                    
                    if (window.gamingChat && window.gamingChat.startMicroGame) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const groupId = urlParams.get('id');
                        
                        if (groupId) {
                            window.gamingChat.startMicroGame(groupId, selectedGame, window.gamingChat.firebaseUser?.uid);
                        } else {
                            alert('Cannot start game. No group selected.');
                        }
                    } else {
                        alert('Gaming system not ready. Please refresh the page.');
                    }
                });
            }
            
            // Mode Selector
            const suggestModeBtn = document.getElementById('suggestModeBtn');
            const modeSelectorModal = document.getElementById('modeSelectorModal');
            const closeModeSelector = document.getElementById('closeModeSelector');
            const confirmSuggestMode = document.getElementById('confirmSuggestMode');
            const modeOptions = document.querySelectorAll('.mode-option');
            
            let selectedMode = null;
            
            if (suggestModeBtn) {
                suggestModeBtn.addEventListener('click', function() {
                    modeSelectorModal.style.display = 'flex';
                });
            }
            
            if (closeModeSelector) {
                closeModeSelector.addEventListener('click', function() {
                    modeSelectorModal.style.display = 'none';
                });
            }
            
            modeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    modeOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMode = this.dataset.mode;
                });
            });
            
            if (confirmSuggestMode) {
                confirmSuggestMode.addEventListener('click', function() {
                    if (!selectedMode) {
                        alert('Please select a mode first!');
                        return;
                    }
                    
                    modeSelectorModal.style.display = 'none';
                    
                    if (window.gamingChat && window.gamingChat.suggestMode) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const groupId = urlParams.get('id');
                        
                        if (groupId) {
                            window.gamingChat.suggestMode(groupId, selectedMode);
                            alert(`Suggested ${getModeName(selectedMode)} to the group! Others can vote to activate it.`);
                        } else {
                            alert('Cannot suggest mode. No group selected.');
                        }
                    } else {
                        alert('Gaming system not ready. Please refresh the page.');
                    }
                });
            }
            
            function getModeName(modeType) {
                const names = {
                    slow: 'Cinematic Slow Mode',
                    chaos: 'Floating Chaos Mode',
                    stealth: 'Blurred Stealth Mode',
                    night_raid: 'Night Raid Mode'
                };
                return names[modeType] || modeType;
            }
            
            // Active Mode Indicator
            const activeModeIndicator = document.getElementById('activeModeIndicator');
            const activeModeName = document.getElementById('activeModeName');
            const modeTimer = document.getElementById('modeTimer');
            
            window.showActiveModeIndicator = function(modeType, timeRemaining) {
                activeModeName.textContent = getModeName(modeType) + ' Active';
                activeModeIndicator.style.display = 'flex';
                updateModeTimer(timeRemaining);
            };
            
            window.hideActiveModeIndicator = function() {
                activeModeIndicator.style.display = 'none';
            };
            
            window.updateModeTimer = function(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                modeTimer.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            };
            
            // Session Timer
            const sessionTimerDisplay = document.getElementById('sessionTimerDisplay');
            const sessionTime = document.getElementById('sessionTime');
            
            window.showSessionTimer = function() {
                sessionTimerDisplay.style.display = 'flex';
            };
            
            window.updateSessionTimer = function(minutes) {
                sessionTime.textContent = `${minutes}m`;
            };
            
            // Achievement Notification
            const achievementNotification = document.getElementById('achievementNotification');
            const achievementTitle = document.getElementById('achievementTitle');
            const achievementDescription = document.getElementById('achievementDescription');
            const achievementIcon = document.getElementById('achievementIcon');
            
            window.showAchievementNotification = function(title, description, icon = 'star') {
                achievementTitle.textContent = title;
                achievementDescription.textContent = description;
                
                // Set icon based on achievement type
                const iconSvg = {
                    star: `<svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`,
                    clock: `<svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
                    zap: `<svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
                    message: `<svg class="feather" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>`
                };
                
                achievementIcon.innerHTML = iconSvg[icon] || iconSvg.star;
                
                achievementNotification.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    achievementNotification.style.display = 'none';
                }, 5000);
            };
            
            // Voice Snippet Player
            window.createVoiceSnippetPlayer = function(audioUrl, duration) {
                const player = document.createElement('div');
                player.className = 'voice-snippet-player';
                player.innerHTML = `
                    <div class="play-pause-btn"></div>
                    <div class="voice-waveform">
                        <div class="voice-progress"></div>
                    </div>
                    <div class="voice-duration">${duration}s</div>
                `;
                
                const audio = new Audio(audioUrl);
                let isPlaying = false;
                let progressInterval = null;
                
                player.querySelector('.play-pause-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    if (!isPlaying) {
                        audio.play();
                        this.textContent = '';
                        isPlaying = true;
                        
                        // Update progress bar
                        progressInterval = setInterval(() => {
                            const progress = (audio.currentTime / audio.duration) * 100;
                            player.querySelector('.voice-progress').style.width = progress + '%';
                            
                            if (audio.currentTime >= audio.duration) {
                                clearInterval(progressInterval);
                                this.textContent = '';
                                isPlaying = false;
                                player.querySelector('.voice-progress').style.width = '0%';
                            }
                        }, 100);
                    } else {
                        audio.pause();
                        this.textContent = '';
                        isPlaying = false;
                        clearInterval(progressInterval);
                    }
                });
                
                // Auto-delete after duration + 5 seconds
                setTimeout(() => {
                    if (player.parentNode) {
                        player.remove();
                    }
                }, (duration + 5) * 1000);
                
                return player;
            };
            
            // Typing Indicator Setup
            const messageInput = document.getElementById('messageInput');
            
            if (messageInput) {
                let typingTimeout = null;
                
                messageInput.addEventListener('input', function() {
                    if (window.gamingChat && window.gamingChat.setTypingStatus) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const groupId = urlParams.get('id');
                        
                        if (groupId) {
                            window.gamingChat.setTypingStatus(groupId, true);
                            
                            // Clear previous timeout
                            if (typingTimeout) {
                                clearTimeout(typingTimeout);
                            }
                            
                            // Set timeout to stop typing indicator after 3 seconds
                            typingTimeout = setTimeout(() => {
                                window.gamingChat.setTypingStatus(groupId, false);
                            }, 3000);
                        }
                    }
                });
                
                // Stop typing when message is sent
                const sendBtn = document.getElementById('sendBtn');
                if (sendBtn) {
                    sendBtn.addEventListener('click', function() {
                        if (typingTimeout) {
                            clearTimeout(typingTimeout);
                        }
                        if (window.gamingChat && window.gamingChat.setTypingStatus) {
                            const urlParams = new URLSearchParams(window.location.search);
                            const groupId = urlParams.get('id');
                            if (groupId) {
                                window.gamingChat.setTypingStatus(groupId, false);
                            }
                        }
                    });
                }
            }
            
            // ========================================
            // EXISTING FUNCTIONALITY
            // ========================================
            
            // CALL BUTTONS FUNCTIONALITY
            const groupVoiceCallBtn = document.getElementById('groupVoiceCallBtn');
            const groupVoiceCallBtnMobile = document.getElementById('groupVoiceCallBtnMobile');
            
            // Function to handle group voice call
            function handleGroupVoiceCall() {
                const urlParams = new URLSearchParams(window.location.search);
                const groupId = urlParams.get('id');
                
                if (!groupId) {
                    alert('Cannot start group call. No group selected.');
                    return;
                }
                
                // Check if calls module is loaded
                if (window.callsModule && window.callsModule.initiateGroupCall) {
                    window.callsModule.initiateGroupCall(groupId);
                } else {
                    // Fallback to direct call if module isn't loaded yet
                    const callId = 'temp_' + Date.now();
                    window.location.href = `calls.html?type=group&groupId=${groupId}&incoming=false&callId=${callId}`;
                }
            }
            
            // Add event listeners to call buttons
            if (groupVoiceCallBtn) {
                groupVoiceCallBtn.addEventListener('click', handleGroupVoiceCall);
            }
            
            if (groupVoiceCallBtnMobile) {
                groupVoiceCallBtnMobile.addEventListener('click', handleGroupVoiceCall);
            }
            
            // Initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            
            // Sidebar toggle functionality
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (sidebar && sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
            }
            
            // Info button functionality
            const infoBtn = document.getElementById('infoBtn');
            if (infoBtn) {
                infoBtn.addEventListener('click', function() {
                    if (sidebar) {
                        sidebar.classList.toggle('active');
                    }
                });
            }
            
            // Handle file attachment
            const attachmentBtn = document.getElementById('attachmentBtn');
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            if (attachmentBtn) {
                attachmentBtn.addEventListener('click', function() {
                    fileInput.click();
                });
            }
            
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    // Handle file upload here
                    console.log('File selected:', files[0]);
                    // You can implement your file upload logic here
                }
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === gameSelectorModal) {
                    gameSelectorModal.style.display = 'none';
                }
                if (event.target === modeSelectorModal) {
                    modeSelectorModal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>